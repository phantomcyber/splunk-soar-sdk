name: Integration Tests

on:
  push:
    branches:
      - main
      - next
      - beta
  pull_request:

jobs:
  build-example-apps:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - example_app
          - example_app_with_webhook
    steps:
      - name: Checkout SDK repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: 3.13

      - name: Build ${{ matrix.app }}
        run: |
          cd tests/${{ matrix.app }}
          echo "Building ${{ matrix.app }} using soarapps CLI"
          uv run --project ../../ soarapps package build . --output-file /tmp/${{ matrix.app }}.tgz
          echo "App build completed successfully"

      - name: Upload app tar file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.app }}-tar
          path: /tmp/${{ matrix.app }}.tgz
          retention-days: 1

  integration-test:
    runs-on:
      - codebuild-github-splunk-soar-sdk-integration-tests-${{ github.run_id }}-${{ github.run_attempt }}
      - image:custom-linux-875003031410.dkr.ecr.us-west-1.amazonaws.com/soar-connectors/pytest:f7150dbb7f347d35f8f4bb285d36985ecd4cf231
    needs: build-example-apps
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: "previous"
            ip: ${{ vars.PHANTOM_INSTANCE_PREVIOUS_VERSION_IP }}
          - version: "current"
            ip: ${{ vars.PHANTOM_INSTANCE_CURRENT_VERSION_IP }}
          - version: "next"
            ip: ${{ vars.PHANTOM_INSTANCE_NEXT_VERSION_IP }}
    env:
      PHANTOM_USERNAME: ${{ vars.PHANTOM_USERNAME }}
      PHANTOM_PASSWORD: ${{ secrets.PHANTOM_PASSWORD }}
      NUM_TEST_RETRIES: ${{ vars.NUM_TEST_RETRIES || '2' }}
    steps:
      - name: Checkout SDK repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: 3.13

      - name: Download example_app tar file
        uses: actions/download-artifact@v4
        with:
          name: example_app-tar
          path: /tmp/

      - name: Download example_app_with_webhook tar file
        uses: actions/download-artifact@v4
        with:
          name: example_app_with_webhook-tar
          path: /tmp/

      - name: Install example_app on Phantom instance
        run: |
          phantom_ip=${{ matrix.ip }}
          export PHANTOM_URL="https://$phantom_ip"
          echo "Installing example_app on $PHANTOM_URL"

          # Install requests for the installer script
          uv run --no-project pip install requests

          # Install the app using the REST installer script
          uv run --no-project python .github/utils/app_rest_installer.py \
            /tmp/example_app.tgz \
            "$phantom_ip" \
            "$PHANTOM_USERNAME" \
            "$PHANTOM_PASSWORD"

          echo "example_app installation complete"

      - name: Install example_app_with_webhook on Phantom instance
        run: |
          phantom_ip=${{ matrix.ip }}
          export PHANTOM_URL="https://$phantom_ip"
          echo "Installing example_app_with_webhook on $PHANTOM_URL"

          # Install the app using the REST installer script
          uv run --no-project python .github/utils/app_rest_installer.py \
            /tmp/example_app_with_webhook.tgz \
            "$phantom_ip" \
            "$PHANTOM_USERNAME" \
            "$PHANTOM_PASSWORD"

          echo "example_app_with_webhook installation complete"

      - name: Run integration tests
        env:
          PHANTOM_URL: "https://${{ matrix.ip }}"
        run: |
          echo "Running integration tests against $PHANTOM_URL"

          # Install dev dependencies (includes pytest and plugins)
          uv sync --group dev

          # Run pytest with integration tests only (no coverage)
          uv run pytest tests/integration/ \
            -v \
            --reruns=$NUM_TEST_RETRIES \
            --tb=short \
            --color=yes \
            --no-cov \
            -m "integration" \
            || exit_code=$?

          echo "Integration tests completed"
          exit ${exit_code:-0}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results-${{ matrix.version }}
          path: |
            pytest-logs/
            test-results/
          retention-days: 1
